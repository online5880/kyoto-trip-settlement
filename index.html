<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>êµí†  ì—¬í–‰ ì •ì‚°</title>
  <style>
    :root{--bg:#f7f8ff;--card:#fff;--line:#e3e6ff;--text:#1d2340;--muted:#6b7397;--primary:#4a67ff}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:26px;margin:8px 0 14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .muted{color:var(--muted);font-size:13px}
    input,select,button{font:inherit}
    input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    button{padding:10px 12px;border:0;border-radius:10px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    button.alt{background:#eef1ff;color:#243279}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .list{margin-top:10px;border-top:1px dashed var(--line);padding-top:10px;max-height:260px;overflow:auto}
    .item{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px solid #f0f2ff}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef1ff;color:#2d3fa5;font-size:12px}
    .danger{background:#e85b5b}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <h1>êµí†  ì—¬í–‰ ì •ì‚° ğŸ’¸</h1>
  <div class="muted">ì—¬í–‰ ê²½ë¹„ë¥¼ ì…ë ¥í•˜ë©´ ëˆ„ê°€ ëˆ„êµ¬ì—ê²Œ ì–¼ë§ˆ ë³´ë‚´ì•¼ í•˜ëŠ”ì§€ ìë™ ê³„ì‚°í•©ë‹ˆë‹¤.</div>

  <div class="grid" style="margin-top:12px;">
    <section class="card">
      <h3>ì°¸ì—¬ì</h3>
      <div class="row">
        <input id="personInput" placeholder="ì´ë¦„ ì…ë ¥" />
        <button id="addPersonBtn">ì¶”ê°€</button>
      </div>
      <div id="persons" class="list"></div>
    </section>

    <section class="card">
      <h3>ì§€ì¶œ ì¶”ê°€</h3>
      <div class="row3">
        <input id="title" placeholder="í•­ëª©(ì˜ˆ: ì ì‹¬)" />
        <input id="amount" type="number" min="0" placeholder="ê¸ˆì•¡" />
        <select id="currency"><option value="JPY">JPY</option><option value="KRW">KRW</option></select>
      </div>
      <div class="row" style="margin-top:8px;">
        <select id="payer"></select>
        <button id="addExpenseBtn">ì§€ì¶œ ë“±ë¡</button>
      </div>
      <div class="muted" style="margin-top:8px;">ë¶„ë°°ëŠ” ì°¸ì—¬ì ì „ì²´ ê· ë“±ë¶„í• </div>
      <div id="expenses" class="list"></div>
    </section>

    <section class="card">
      <h3>í™˜ìœ¨ ì„¤ì •</h3>
      <div class="row">
        <input id="jpyToKrw" type="number" step="0.01" value="9.0" />
        <button id="saveRateBtn" class="alt">ì €ì¥</button>
      </div>
      <div class="muted" style="margin-top:8px;">1 JPY = ? KRW</div>
    </section>

    <section class="card">
      <h3>ì •ì‚° ê²°ê³¼</h3>
      <div id="summary" class="list"></div>
      <div id="transfers" class="list"></div>
    </section>
  </div>
</div>

<script>
const KEY='kyoto-settlement-v1';
const state=JSON.parse(localStorage.getItem(KEY)||'{"persons":["ë§ˆë„¤"],"expenses":[],"rate":9.0}');

const $=id=>document.getElementById(id);

function save(){localStorage.setItem(KEY,JSON.stringify(state)); render();}

function toKrw(amount,c){return c==='KRW'?amount:amount*state.rate;}

function renderPersons(){
  const box=$('persons'); box.innerHTML='';
  state.persons.forEach((p,i)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<span>${p}</span><button class='danger' data-i='${i}'>ì‚­ì œ</button>`;
    div.querySelector('button').onclick=()=>{ if(state.persons.length<=1) return; state.persons.splice(i,1); state.expenses=state.expenses.filter(e=>e.payer!==p); save(); };
    box.appendChild(div);
  });

  const payer=$('payer'); payer.innerHTML='';
  state.persons.forEach(p=>{const o=document.createElement('option'); o.value=p; o.textContent=p; payer.appendChild(o);});
}

function renderExpenses(){
  const box=$('expenses'); box.innerHTML='';
  state.expenses.forEach((e,i)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<span><span class='pill'>${e.payer}</span> ${e.title} - ${Number(e.amount).toLocaleString()} ${e.currency}</span><button class='danger'>ì‚­ì œ</button>`;
    div.querySelector('button').onclick=()=>{state.expenses.splice(i,1); save();};
    box.appendChild(div);
  });
}

function calc(){
  const n=state.persons.length||1;
  const bal={}; state.persons.forEach(p=>bal[p]=0);
  for(const e of state.expenses){
    const krw=toKrw(Number(e.amount),e.currency);
    const share=krw/n;
    bal[e.payer]+=krw;
    state.persons.forEach(p=>bal[p]-=share);
  }
  return bal;
}

function renderSettlement(){
  const bal=calc();
  const sum=$('summary'); sum.innerHTML='';
  Object.entries(bal).forEach(([p,v])=>{
    const d=document.createElement('div'); d.className='item';
    d.innerHTML=`<span>${p}</span><strong>${Math.round(v).toLocaleString()} KRW</strong>`;
    sum.appendChild(d);
  });

  const debtors=[], creditors=[];
  for(const [p,v] of Object.entries(bal)){
    if(v<-1) debtors.push([p,-v]);
    if(v>1) creditors.push([p,v]);
  }
  debtors.sort((a,b)=>b[1]-a[1]); creditors.sort((a,b)=>b[1]-a[1]);

  const t=$('transfers'); t.innerHTML='';
  let i=0,j=0;
  while(i<debtors.length && j<creditors.length){
    const [dp,da]=debtors[i]; const [cp,ca]=creditors[j];
    const m=Math.min(da,ca);
    const d=document.createElement('div'); d.className='item';
    d.innerHTML=`<span>${dp} â†’ ${cp}</span><strong>${Math.round(m).toLocaleString()} KRW</strong>`;
    t.appendChild(d);
    debtors[i][1]-=m; creditors[j][1]-=m;
    if(debtors[i][1]<=1) i++; if(creditors[j][1]<=1) j++;
  }
}

function render(){
  $('jpyToKrw').value=state.rate;
  renderPersons();
  renderExpenses();
  renderSettlement();
}

$('addPersonBtn').onclick=()=>{
  const v=$('personInput').value.trim();
  if(!v) return;
  if(state.persons.includes(v)) return;
  state.persons.push(v); $('personInput').value=''; save();
};

$('addExpenseBtn').onclick=()=>{
  const title=$('title').value.trim()||'ì§€ì¶œ';
  const amount=Number($('amount').value||0);
  const currency=$('currency').value;
  const payer=$('payer').value;
  if(amount<=0||!payer) return;
  state.expenses.push({title,amount,currency,payer,createdAt:Date.now()});
  $('title').value=''; $('amount').value=''; save();
};

$('saveRateBtn').onclick=()=>{const r=Number($('jpyToKrw').value||0); if(r>0){state.rate=r; save();}};

render();
</script>
</body>
</html>