<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>êµí†  ì—¬í–‰ ì •ì‚°</title>
  <style>
    :root {
      --bg1: #f2f6ff;
      --bg2: #fff3f7;
      --card: rgba(255,255,255,0.86);
      --line: #dfe5ff;
      --text: #1d2340;
      --muted: #6b7397;
      --primary: #4a67ff;
      --primary2: #6e86ff;
      --danger: #e45c5c;
      --ok: #25a56a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--text);
      font-family: Inter, Apple SD Gothic Neo, Noto Sans KR, sans-serif;
      background:
        radial-gradient(circle at 10% 8%, #dce7ff 0, transparent 30%),
        radial-gradient(circle at 90% 2%, #ffd9e9 0, transparent 27%),
        linear-gradient(150deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height: 100vh;
    }
    .wrap { width: min(98vw, 1600px); margin: 0 auto; padding: 10px; }
    .header {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(43, 66, 178, 0.08);
    }
    h1 { margin: 0 0 6px; font-size: 28px; }
    .muted { color: var(--muted); font-size: 13px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }

    .grid { margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: stretch; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 8px 20px rgba(43, 66, 178, 0.06);
      display: flex;
      flex-direction: column;
      min-height: 230px;
    }
    .card h3 { margin: 0 0 10px; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .row4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }
    @media (max-width: 760px) {
      .row, .row3, .row4 { grid-template-columns: 1fr; }
    }

    input, select, textarea, button { font: inherit; }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      color: var(--text);
    }
    textarea { min-height: 68px; resize: vertical; }

    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 12px;
      color: #fff;
      background: linear-gradient(120deg, var(--primary), var(--primary2));
      font-weight: 700;
      cursor: pointer;
    }
    button.alt { background: #eef2ff; color: #2a3a92; border: 1px solid var(--line); }
    button.danger { background: var(--danger); }
    button.ok { background: var(--ok); }

    .list {
      margin-top: 8px;
      border-top: 1px dashed var(--line);
      padding-top: 8px;
      flex: 1;
      overflow: auto;
      min-height: 90px;
    }
    .item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid #eef1ff;
    }
    .item-main { display: flex; flex-direction: column; gap: 3px; }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #edf1ff;
      color: #2f43a5;
      font-size: 12px;
      margin-right: 5px;
    }
    .sub { color: var(--muted); font-size: 12px; }

    .totals {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    .total-box {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #fff;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="header">
      <h1>êµí†  ì—¬í–‰ ì •ì‚° âœˆï¸ğŸ’´</h1>
      <div class="muted">Cloudflare D1 ì„œë²„ ì €ì¥ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤. (ë¡œì»¬ ì €ì¥ ì—†ìŒ)</div>
      <div class="toolbar">
        <button class="alt" id="copyShareBtn">ê³µìœ  ë§í¬ ìƒì„±/ë³µì‚¬ (DB)</button>
        <button class="alt" id="loadShareBtn">ë§í¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (DB)</button>
        <button class="danger" id="resetBtn">ì „ì²´ ì´ˆê¸°í™”</button>
        <span id="status" class="muted"></span>
      </div>
    </section>

    <div class="grid">
      <section class="card">
        <h3>ì°¸ì—¬ì</h3>
        <div class="row">
          <input id="personInput" placeholder="ì´ë¦„ ì…ë ¥ (ì˜ˆ: ë§ˆë„¤)" />
          <button id="addPersonBtn">ì°¸ì—¬ì ì¶”ê°€</button>
        </div>
        <div id="persons" class="list"></div>
      </section>

      <section class="card">
        <h3>ì§€ì¶œ ì¶”ê°€</h3>
        <div class="row4">
          <input id="title" placeholder="í•­ëª©ëª… (ì˜ˆ: ì ì‹¬)" />
          <select id="category">
            <option value="ì‹ë¹„">ì‹ë¹„</option>
            <option value="êµí†µ">êµí†µ</option>
            <option value="ìˆ™ì†Œ">ìˆ™ì†Œ</option>
            <option value="ê´€ê´‘">ê´€ê´‘</option>
            <option value="ì‡¼í•‘">ì‡¼í•‘</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
          <input id="amount" type="number" min="0" placeholder="ê¸ˆì•¡" />
          <select id="currency">
            <option value="JPY">JPY</option>
            <option value="KRW">KRW</option>
          </select>
        </div>
        <div class="row" style="margin-top:8px;">
          <select id="payer"></select>
          <button id="addExpenseBtn">ì§€ì¶œ ë“±ë¡</button>
        </div>
        <div style="margin-top:8px;">
          <textarea id="memo" placeholder="ì˜ìˆ˜ì¦ ë©”ëª¨ (ì˜ˆ: ëˆí‚¤í˜¸í…Œ, ì¹´ë“œê²°ì œ, 3ëª… ë¶„í• )"></textarea>
        </div>
        <div class="sub" style="margin-top:6px;">ê¸°ë³¸ ë¶„ë°°: ì°¸ì—¬ì ì „ì²´ ê· ë“±</div>
        <div id="expenses" class="list"></div>
      </section>

      <section class="card">
        <h3>í™˜ìœ¨ ì„¤ì •</h3>
        <div class="row">
          <input id="jpyToKrw" type="number" step="0.01" value="9.0" />
          <button id="saveRateBtn" class="ok">í™˜ìœ¨ ì €ì¥</button>
        </div>
        <div class="sub" style="margin-top:8px;">1 JPY = ? KRW</div>

        <div class="totals">
          <div class="total-box">
            <div class="sub">ì´ ì§€ì¶œ (KRW í™˜ì‚°)</div>
            <strong id="totalKrw">0 KRW</strong>
          </div>
          <div class="total-box">
            <div class="sub">1ì¸ë‹¹ ë¶€ë‹´</div>
            <strong id="perHeadKrw">0 KRW</strong>
          </div>
        </div>
      </section>

      <section class="card">
        <h3>ì •ì‚° ê²°ê³¼</h3>
        <div class="sub">+ëŠ” ë°›ì„ ëˆ / -ëŠ” ë³´ë‚¼ ëˆ</div>
        <div id="summary" class="list"></div>
        <div class="sub" style="margin-top:8px; font-weight:700;">ì†¡ê¸ˆ ê°€ì´ë“œ</div>
        <div id="transfers" class="list"></div>
      </section>
    </div>
  </div>

  <script>
    const defaultState = {
      persons: ['ë§ˆë„¤'],
      expenses: [],
      rate: 9.0
    };

    const state = structuredClone(defaultState);

    const $ = (id) => document.getElementById(id);
    const statusEl = $('status');

    let currentShareId = null;
    let isRemoteApplying = false;
    let syncTimer = null;
    let pollTimer = null;
    let lastRemoteFingerprint = '';

    function fingerprint(obj) {
      return JSON.stringify(obj);
    }


    function setStatus(msg) {
      statusEl.textContent = msg;
      setTimeout(() => {
        if (statusEl.textContent === msg) statusEl.textContent = '';
      }, 1800);
    }

    function save() {
            render();
      scheduleSync();
    }

    function toKrw(amount, c) {
      return c === 'KRW' ? amount : amount * Number(state.rate || 0);
    }

    function b64urlEncode(str) {
      return btoa(unescape(encodeURIComponent(str))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
    }
    function b64urlDecode(str) {
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      while (str.length % 4) str += '=';
      return decodeURIComponent(escape(atob(str)));
    }

    async function createShareUrlOnServer() {
      const res = await fetch('/api/share', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state }),
      });
      if (!res.ok) throw new Error('ê³µìœ  ì €ì¥ ì‹¤íŒ¨');
      const body = await res.json();
      return body.url;
    }

    async function loadFromLink() {
      const u = new URL(location.href);
      const sid = u.searchParams.get('sid');
      const s = u.searchParams.get('s'); // legacy support

      if (sid) {
        try {
          currentShareId = sid;
          const res = await fetch(`/api/share/${encodeURIComponent(sid)}`);
          if (!res.ok) throw new Error('not found');
          const body = await res.json();
          const obj = body.state;
          if (!obj || !Array.isArray(obj.persons) || !Array.isArray(obj.expenses)) throw new Error('bad data');
          state.persons = obj.persons;
          state.expenses = obj.expenses;
          state.rate = Number(obj.rate || 9.0);
          save();
          lastRemoteFingerprint = fingerprint(state);
          startPolling();
          setStatus('DB ê³µìœ  ë§í¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ (ì‹¤ì‹œê°„ ë™ê¸°í™” ON)');
          return true;
        } catch {
          setStatus('DB ê³µìœ  ë§í¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
          return false;
        }
      }

      if (s) {
        // legacy mode: encoded state in URL
        try {
          const obj = JSON.parse(b64urlDecode(s));
          if (!obj || !Array.isArray(obj.persons) || !Array.isArray(obj.expenses)) throw new Error('bad data');
          state.persons = obj.persons;
          state.expenses = obj.expenses;
          state.rate = Number(obj.rate || 9.0);
          save();
          setStatus('ë§í¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ(legacy)');
          return true;
        } catch {
          setStatus('ë§í¬ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨');
          return false;
        }
      }

      return false;
    }


    async function updateShareOnServer() {
      if (!currentShareId || isRemoteApplying) return;
      try {
        await fetch(`/api/share/${encodeURIComponent(currentShareId)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state }),
        });
      } catch {
        // ignore background sync errors
      }
    }

    function scheduleSync() {
      if (!currentShareId || isRemoteApplying) return;
      clearTimeout(syncTimer);
      syncTimer = setTimeout(() => {
        updateShareOnServer();
      }, 700);
    }

    async function pollRemote() {
      if (!currentShareId || isRemoteApplying) return;
      try {
        const res = await fetch(`/api/share/${encodeURIComponent(currentShareId)}`);
        if (!res.ok) return;
        const body = await res.json();
        const remote = body?.state;
        if (!remote) return;

        const f = fingerprint(remote);
        if (!lastRemoteFingerprint) {
          lastRemoteFingerprint = f;
          return;
        }
        if (f === lastRemoteFingerprint) return;

        isRemoteApplying = true;
        state.persons = Array.isArray(remote.persons) ? remote.persons : ['ë§ˆë„¤'];
        state.expenses = Array.isArray(remote.expenses) ? remote.expenses : [];
        state.rate = Number(remote.rate || 9.0);
                render();
        setStatus('ë‹¤ë¥¸ ì‚¬ìš©ì ë³€ê²½ì‚¬í•­ ë™ê¸°í™”ë¨');
        isRemoteApplying = false;

        lastRemoteFingerprint = f;
      } catch {
        // ignore poll errors
      }
    }

    function startPolling() {
      if (pollTimer) clearInterval(pollTimer);
      if (!currentShareId) return;
      pollTimer = setInterval(pollRemote, 4000);
    }

    function renderPersons() {
      const box = $('persons'); box.innerHTML = '';
      state.persons.forEach((p, i) => {
        const div = document.createElement('div'); div.className = 'item';
        div.innerHTML = `<span>${p}</span><button class="danger" data-i="${i}">ì‚­ì œ</button>`;
        div.querySelector('button').onclick = () => {
          if (state.persons.length <= 1) return;
          state.persons.splice(i, 1);
          state.expenses = state.expenses.filter(e => e.payer !== p);
          save();
        };
        box.appendChild(div);
      });

      const payer = $('payer'); payer.innerHTML = '';
      state.persons.forEach(p => {
        const o = document.createElement('option');
        o.value = p; o.textContent = p;
        payer.appendChild(o);
      });
    }

    function renderExpenses() {
      const box = $('expenses'); box.innerHTML = '';
      state.expenses.forEach((e, i) => {
        const krw = toKrw(Number(e.amount || 0), e.currency);
        const div = document.createElement('div'); div.className = 'item';
        div.innerHTML = `
          <div class="item-main">
            <div>
              <span class="pill">${e.category || 'ê¸°íƒ€'}</span>
              <span class="pill">${e.payer}</span>
              ${e.title || 'ì§€ì¶œ'}
            </div>
            <div class="sub">${Number(e.amount).toLocaleString()} ${e.currency} (â‰ˆ ${Math.round(krw).toLocaleString()} KRW)</div>
            ${e.memo ? `<div class="sub">ğŸ§¾ ${e.memo}</div>` : ''}
          </div>
          <button class="danger">ì‚­ì œ</button>
        `;
        div.querySelector('button').onclick = () => { state.expenses.splice(i, 1); save(); };
        box.appendChild(div);
      });
    }

    function calc() {
      const n = Math.max(1, state.persons.length);
      const bal = Object.fromEntries(state.persons.map(p => [p, 0]));
      let total = 0;

      for (const e of state.expenses) {
        const krw = toKrw(Number(e.amount || 0), e.currency);
        total += krw;
        const share = krw / n;
        bal[e.payer] += krw;
        for (const p of state.persons) bal[p] -= share;
      }
      return { bal, total, perHead: total / n };
    }

    function renderSettlement() {
      const { bal, total, perHead } = calc();
      $('totalKrw').textContent = `${Math.round(total).toLocaleString()} KRW`;
      $('perHeadKrw').textContent = `${Math.round(perHead).toLocaleString()} KRW`;

      const sum = $('summary'); sum.innerHTML = '';
      Object.entries(bal).forEach(([p, v]) => {
        const d = document.createElement('div'); d.className = 'item';
        d.innerHTML = `<span>${p}</span><strong>${Math.round(v).toLocaleString()} KRW</strong>`;
        sum.appendChild(d);
      });

      const debtors = [], creditors = [];
      for (const [p, v] of Object.entries(bal)) {
        if (v < -1) debtors.push([p, -v]);
        if (v > 1) creditors.push([p, v]);
      }
      debtors.sort((a, b) => b[1] - a[1]);
      creditors.sort((a, b) => b[1] - a[1]);

      const t = $('transfers'); t.innerHTML = '';
      let i = 0, j = 0;
      while (i < debtors.length && j < creditors.length) {
        const [dp, da] = debtors[i];
        const [cp, ca] = creditors[j];
        const m = Math.min(da, ca);
        const d = document.createElement('div'); d.className = 'item';
        d.innerHTML = `<span>${dp} â†’ ${cp}</span><strong>${Math.round(m).toLocaleString()} KRW</strong>`;
        t.appendChild(d);
        debtors[i][1] -= m; creditors[j][1] -= m;
        if (debtors[i][1] <= 1) i++;
        if (creditors[j][1] <= 1) j++;
      }
    }

    function render() {
      $('jpyToKrw').value = state.rate;
      renderPersons();
      renderExpenses();
      renderSettlement();
    }

    $('addPersonBtn').onclick = () => {
      const v = $('personInput').value.trim();
      if (!v || state.persons.includes(v)) return;
      state.persons.push(v);
      $('personInput').value = '';
      save();
    };

    $('addExpenseBtn').onclick = () => {
      const title = $('title').value.trim() || 'ì§€ì¶œ';
      const category = $('category').value || 'ê¸°íƒ€';
      const amount = Number($('amount').value || 0);
      const currency = $('currency').value;
      const payer = $('payer').value;
      const memo = $('memo').value.trim();
      if (amount <= 0 || !payer) return;
      state.expenses.push({ title, category, amount, currency, payer, memo, createdAt: Date.now() });
      $('title').value = '';
      $('amount').value = '';
      $('memo').value = '';
      save();
    };

    $('saveRateBtn').onclick = () => {
      const r = Number($('jpyToKrw').value || 0);
      if (r > 0) { state.rate = r; save(); }
    };

    $('copyShareBtn').onclick = async () => {
      try {
        setStatus('ê³µìœ  ë§í¬ ìƒì„± ì¤‘...');
        const url = await createShareUrlOnServer();
        try {
          const u = new URL(url);
          currentShareId = u.searchParams.get('sid');
          lastRemoteFingerprint = fingerprint(state);
          history.replaceState(null, '', u.toString());
          startPolling();
        } catch {}
        try {
          await navigator.clipboard.writeText(url);
          setStatus('ê³µìœ  ë§í¬ ë³µì‚¬ ì™„ë£Œ (DB, ì‹¤ì‹œê°„ ë™ê¸°í™” ON)');
        } catch {
          prompt('ë³µì‚¬í•´ì„œ ê³µìœ í•˜ì„¸ìš”:', url);
        }
      } catch {
        setStatus('ê³µìœ  ë§í¬ ìƒì„± ì‹¤íŒ¨');
      }
    };

    $('loadShareBtn').onclick = async () => { await loadFromLink(); };

    $('resetBtn').onclick = () => {
      if (!confirm('ì „ì²´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      state.persons = ['ë§ˆë„¤'];
      state.expenses = [];
      state.rate = 9.0;
      save();
      setStatus('ì´ˆê¸°í™” ì™„ë£Œ');
    };

    loadFromLink();
    render();
    if (new URL(location.href).searchParams.get('sid')) {
      currentShareId = new URL(location.href).searchParams.get('sid');
      startPolling();
    }
  </script>
</body>
</html>