<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>êµí†  ì—¬í–‰ ì •ì‚°</title>
  <style>
    :root {
      --bg1: #f2f6ff;
      --bg2: #fff3f7;
      --card: rgba(255,255,255,0.9);
      --line: #dfe5ff;
      --text: #1d2340;
      --muted: #6b7397;
      --primary: #4a67ff;
      --primary2: #6e86ff;
      --danger: #e45c5c;
      --ok: #25a56a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--text);
      font-family: Inter, Apple SD Gothic Neo, Noto Sans KR, sans-serif;
      background:
        radial-gradient(circle at 10% 8%, #dce7ff 0, transparent 30%),
        radial-gradient(circle at 90% 2%, #ffd9e9 0, transparent 27%),
        linear-gradient(150deg, var(--bg1) 0%, var(--bg2) 100%);
      min-height: 100vh;
      overflow: hidden;
    }
    .wrap { width: min(98vw, 1600px); margin: 0 auto; padding: 10px; height: 100vh; display: flex; flex-direction: column; gap: 8px; }
    .header {
      flex: 0 0 auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(43, 66, 178, 0.08);
    }
    h1 { margin: 0 0 6px; font-size: 28px; }
    .muted { color: var(--muted); font-size: 13px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; align-items: center; }

    .kpi-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }
    .kpi {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      padding: 10px;
    }
    .kpi .label { font-size: 12px; color: var(--muted); }
    .kpi .value { font-size: 22px; font-weight: 800; margin-top: 2px; }

    .grid { margin-top: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: stretch; flex: 1 1 auto; min-height: 0; overflow: hidden; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; overflow: visible; } .kpi-grid { grid-template-columns: 1fr 1fr; } body{overflow:auto;} .wrap{height:auto;} .card{height:auto;} }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 8px 20px rgba(43, 66, 178, 0.06);
      display: flex;
      flex-direction: column;
      min-height: 0;
      height: 100%;
      overflow: hidden;
    }
    .card h3 { margin: 0 0 10px; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .row4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }
    @media (max-width: 760px) {
      .row, .row3, .row4 { grid-template-columns: 1fr; }
    }

    input, select, textarea, button { font: inherit; }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      color: var(--text);
    }
    textarea { min-height: 60px; resize: vertical; }

    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 12px;
      color: #fff;
      background: linear-gradient(120deg, var(--primary), var(--primary2));
      font-weight: 700;
      cursor: pointer;
    }
    button.alt { background: #eef2ff; color: #2a3a92; border: 1px solid var(--line); }
    button.danger { background: var(--danger); }
    button.ok { background: var(--ok); }

    .list {
      margin-top: 8px;
      border-top: 1px dashed var(--line);
      padding-top: 8px;
      flex: 1;
      overflow: auto;
      min-height: 0;
    }
    .item {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid #eef1ff;
    }
    .item-main { display: flex; flex-direction: column; gap: 3px; }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #edf1ff;
      color: #2f43a5;
      font-size: 12px;
      margin-right: 5px;
    }
    .sub { color: var(--muted); font-size: 12px; }
    .transfer-row { display:flex; align-items:center; gap:8px; }
    .transfer-row input[type="checkbox"] { transform: scale(1.15); }
    .done { opacity: .55; text-decoration: line-through; }

    .totals { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
    .total-box { border: 1px solid var(--line); border-radius: 10px; padding: 10px; background: #fff; }

    .ok-dot { width:8px; height:8px; border-radius:50%; background:#29b36f; display:inline-block; margin-right:5px; }
    .warn-dot { width:8px; height:8px; border-radius:50%; background:#d89d00; display:inline-block; margin-right:5px; }

    .fund-section { display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="header">
      <h1>êµí†  ì—¬í–‰ ì •ì‚° âœˆï¸ğŸ’´</h1>
      <div class="muted">Cloudflare D1 ì„œë²„ ì €ì¥ ì „ìš© + ê°™ì€ ë§í¬(`sid`) ì‹¤ì‹œê°„ ë™ê¸°í™”</div>
      <div class="toolbar">
        <button class="alt" id="copyShareBtn">ê³µìœ  ë§í¬ ìƒì„±/ë³µì‚¬ (DB)</button>
        <button class="alt" id="loadShareBtn">ë§í¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (DB)</button>
        <button class="danger" id="resetBtn">ì „ì²´ ì´ˆê¸°í™”</button>
        <span id="syncState" class="muted"><span class="warn-dot"></span>ë¯¸ì—°ê²°</span>
        <span id="status" class="muted"></span>
      </div>

      <div class="kpi-grid">
        <div class="kpi"><div class="label">ì´ ì§€ì¶œ</div><div id="kpiTotal" class="value">0 KRW</div></div>
        <div class="kpi"><div class="label">ê³µê¸ˆ í¬í•¨ í•©ê³„</div><div id="kpiNet" class="value">0 KRW</div></div>
        <div class="kpi"><div class="label">1ì¸ë‹¹ ë¶€ë‹´</div><div id="kpiPerHead" class="value">0 KRW</div></div>
        <div class="kpi"><div class="label">ì •ì‚° ì™„ë£Œ</div><div id="kpiDone" class="value">0%</div></div>
      </div>
    </section>

    <div class="grid">
      <section class="card">
        <h3>ì°¸ì—¬ì</h3>
        <div class="row">
          <input id="personInput" placeholder="ì´ë¦„ ì…ë ¥ (ì˜ˆ: ë§ˆë„¤)" />
          <button id="addPersonBtn">ì°¸ì—¬ì ì¶”ê°€</button>
        </div>
        <div id="persons" class="list"></div>
      </section>

      <section class="card">
        <h3>ì§€ì¶œ ì¶”ê°€</h3>
        <div class="row4">
          <input id="title" placeholder="í•­ëª©ëª… (ì˜ˆ: ì ì‹¬)" />
          <select id="category">
            <option value="ì‹ë¹„">ì‹ë¹„</option>
            <option value="êµí†µ">êµí†µ</option>
            <option value="ìˆ™ì†Œ">ìˆ™ì†Œ</option>
            <option value="ê´€ê´‘">ê´€ê´‘</option>
            <option value="ì‡¼í•‘">ì‡¼í•‘</option>
            <option value="ê³µê¸ˆ">ê³µê¸ˆ</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
          <input id="amount" type="number" min="0" placeholder="ê¸ˆì•¡" />
          <select id="currency"><option value="JPY">JPY</option><option value="KRW">KRW</option></select>
        </div>
        <div class="row" style="margin-top:8px;">
          <select id="payer"></select>
          <button id="addExpenseBtn">ì§€ì¶œ ë“±ë¡</button>
        </div>
        <div style="margin-top:8px;"><textarea id="memo" placeholder="ì˜ìˆ˜ì¦ ë©”ëª¨"></textarea></div>
        <div class="sub" style="margin-top:6px;">ê¸°ë³¸ ë¶„ë°°: ì°¸ì—¬ì ì „ì²´ ê· ë“±</div>
        <div id="expenses" class="list"></div>
      </section>

      <section class="card fund-section">
        <h3>ê³µê¸ˆ ì¶”ê°€</h3>
        <div class="row4">
          <input id="fundTitle" placeholder="ê³µê¸ˆëª… (ì˜ˆ: ì—¬í–‰ ê³µê¸ˆ)" />
          <select id="fundCategory">
            <option value="ê³µê¸ˆ">ê³µê¸ˆ</option>
            <option value="ì˜ˆë¹„ë¹„">ì˜ˆë¹„ë¹„</option>
          </select>
          <input id="fundAmount" type="number" min="0" placeholder="ê¸ˆì•¡" />
          <select id="fundCurrency"><option value="JPY">JPY</option><option value="KRW">KRW</option></select>
        </div>
        <div class="row" style="margin-top:8px;">
          <select id="fundPayer"></select>
          <button id="addFundBtn" class="ok">ê³µê¸ˆ ë“±ë¡</button>
        </div>
        <div style="margin-top:8px;"><textarea id="fundMemo" placeholder="ê³µê¸ˆ ë©”ëª¨"></textarea></div>
        <div class="sub" style="margin-top:6px;">ê³µê¸ˆì€ ì „ì²´ê°€ í•¨ê»˜ ë¶€ë‹´í•œ ì„ ë‚©ê¸ˆìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</div>
        <div id="funds" class="list"></div>
      </section>

      <section class="card">
        <h3>í™˜ìœ¨ ì„¤ì •</h3>
        <div class="row">
          <input id="rateDisplay" value="ë¡œë”© ì¤‘..." readonly />
          <button id="fetchRateBtn" class="alt">í™˜ìœ¨ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="sub" style="margin-top:8px;">JPYâ†’KRW í™˜ìœ¨ì€ API ê°’ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.</div>
        <div class="sub" id="rateMeta" style="margin-top:4px;"></div>

        <div class="totals">
          <div class="total-box"><div class="sub">ì´ ì§€ì¶œ (KRW)</div><strong id="totalKrw">0 KRW</strong></div>
          <div class="total-box"><div class="sub">ê³µê¸ˆ ì´ì•¡ (KRW)</div><strong id="totalFundKrw">0 KRW</strong></div>
          <div class="total-box"><div class="sub">ì •ì‚° ëŒ€ìƒ ì´ì•¡ (KRW)</div><strong id="netKrw">0 KRW</strong></div>
          <div class="total-box"><div class="sub">1ì¸ë‹¹ ë¶€ë‹´</div><strong id="perHeadKrw">0 KRW</strong></div>
        </div>
      </section>

      <section class="card">
        <h3>ì •ì‚° ê²°ê³¼</h3>
        <div class="sub">+ëŠ” ë°›ì„ ëˆ / -ëŠ” ë³´ë‚¼ ëˆ</div>
        <div id="summary" class="list"></div>
        <div class="sub" style="margin-top:8px; font-weight:700;">ì†¡ê¸ˆ ê°€ì´ë“œ</div>
        <div id="transfers" class="list"></div>
      </section>
    </div>
  </div>

  <script>
    const defaultState = { persons: ['ë§ˆë„¤'], expenses: [], funds: [], rate: 9.0, settled: {} };
    const state = structuredClone(defaultState);

    const $ = (id) => document.getElementById(id);
    const statusEl = $('status');
    const syncStateEl = $('syncState');

    let currentShareId = null;
    let isRemoteApplying = false;
    let syncTimer = null;
    let pollTimer = null;
    let lastRemoteFingerprint = '';

    const fp = (obj) => JSON.stringify(obj);
    const toKrw = (amount, c) => c === 'KRW' ? amount : amount * Number(state.rate || 0);

    function setStatus(msg){
      statusEl.textContent = msg;
      setTimeout(()=>{ if(statusEl.textContent===msg) statusEl.textContent=''; }, 2000);
    }

    function setSyncState(connected){
      if(connected){
        syncStateEl.innerHTML = '<span class="ok-dot"></span>ì‹¤ì‹œê°„ ë™ê¸°í™” ON';
      } else {
        syncStateEl.innerHTML = '<span class="warn-dot"></span>ë¯¸ì—°ê²°';
      }
    }

    function save(){
      render();
      scheduleSync();
    }

    async function createShareUrlOnServer(){
      const res = await fetch('/api/share', {
        method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({state})
      });
      if(!res.ok) throw new Error('share create failed');
      return await res.json();
    }

    async function updateShareOnServer(){
      if(!currentShareId || isRemoteApplying) return;
      try{
        await fetch(`/api/share/${encodeURIComponent(currentShareId)}`, {
          method:'PUT', headers:{'content-type':'application/json'}, body: JSON.stringify({state})
        });
      } catch {}
    }

    function scheduleSync(){
      if(!currentShareId || isRemoteApplying) return;
      clearTimeout(syncTimer);
      syncTimer=setTimeout(updateShareOnServer, 600);
    }

    async function pollRemote(){
      if(!currentShareId || isRemoteApplying) return;
      try{
        const res = await fetch(`/api/share/${encodeURIComponent(currentShareId)}`);
        if(!res.ok) return;
        const body = await res.json();
        const remote = body?.state;
        if(!remote) return;
        const remoteFp = fp(remote);
        if(!lastRemoteFingerprint){ lastRemoteFingerprint = remoteFp; return; }
        if(remoteFp === lastRemoteFingerprint) return;

        isRemoteApplying = true;
        state.persons = Array.isArray(remote.persons) ? remote.persons : ['ë§ˆë„¤'];
        state.expenses = Array.isArray(remote.expenses) ? remote.expenses : [];
        state.funds = Array.isArray(remote.funds) ? remote.funds : [];
        state.rate = Number(remote.rate || 9.0);
        state.settled = (remote.settled && typeof remote.settled === 'object') ? remote.settled : {};
        render();
        lastRemoteFingerprint = remoteFp;
        setStatus('ë‹¤ë¥¸ ì‚¬ìš©ì ë³€ê²½ì‚¬í•­ ë°˜ì˜ë¨');
      } catch {} finally {
        isRemoteApplying = false;
      }
    }

    function startPolling(){
      if(pollTimer) clearInterval(pollTimer);
      if(!currentShareId) return;
      setSyncState(true);
      pollTimer = setInterval(pollRemote, 4000);
    }

    async function loadFromLink(){
      const u = new URL(location.href);
      const sid = u.searchParams.get('sid');
      if(!sid){ setSyncState(false); return false; }
      try{
        currentShareId = sid;
        const res = await fetch(`/api/share/${encodeURIComponent(sid)}`);
        if(!res.ok) throw new Error('not found');
        const body = await res.json();
        const obj = body.state;
        state.persons = Array.isArray(obj.persons) ? obj.persons : ['ë§ˆë„¤'];
        state.expenses = Array.isArray(obj.expenses) ? obj.expenses : [];
        state.funds = Array.isArray(obj.funds) ? obj.funds : [];
        state.rate = Number(obj.rate || 9.0);
        state.settled = (obj.settled && typeof obj.settled === 'object') ? obj.settled : {};
        lastRemoteFingerprint = fp(state);
        render();
        startPolling();
        setStatus('DB ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
        return true;
      } catch {
        setStatus('DB ë§í¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
        return false;
      }
    }

    function renderPersons(){
      const box = $('persons'); box.innerHTML='';
      state.persons.forEach((p,i)=>{
        const div=document.createElement('div'); div.className='item';
        div.innerHTML = `<span>${p}</span><button class="danger">ì‚­ì œ</button>`;
        div.querySelector('button').onclick = ()=>{
          if(state.persons.length<=1) return;
          state.persons.splice(i,1);
          state.expenses = state.expenses.filter(e=>e.payer!==p);
          state.funds = state.funds.filter(e=>e.payer!==p);
          save();
        };
        box.appendChild(div);
      });

      const payerSel = ['payer','fundPayer'];
      payerSel.forEach(id=>{
        const el=$(id); el.innerHTML='';
        state.persons.forEach(p=>{
          const o=document.createElement('option'); o.value=p; o.textContent=p; el.appendChild(o);
        });
      });
    }

    function renderExpenses(){
      const box=$('expenses'); box.innerHTML='';
      state.expenses.forEach((e,i)=>{
        const krw = toKrw(Number(e.amount||0), e.currency);
        const div=document.createElement('div'); div.className='item';
        div.innerHTML = `<div class="item-main">
          <div><span class="pill">${e.category||'ê¸°íƒ€'}</span><span class="pill">${e.payer}</span>${e.title||'ì§€ì¶œ'}</div>
          <div class="sub">${Number(e.amount).toLocaleString()} ${e.currency} (â‰ˆ ${Math.round(krw).toLocaleString()} KRW)</div>
          ${e.memo ? `<div class="sub">ğŸ§¾ ${e.memo}</div>` : ''}
        </div><button class="danger">ì‚­ì œ</button>`;
        div.querySelector('button').onclick=()=>{ state.expenses.splice(i,1); save(); };
        box.appendChild(div);
      });
    }

    function renderFunds(){
      const box=$('funds'); box.innerHTML='';
      state.funds.forEach((f,i)=>{
        const krw = toKrw(Number(f.amount||0), f.currency);
        const div=document.createElement('div'); div.className='item';
        div.innerHTML = `<div class="item-main">
          <div><span class="pill">${f.category||'ê³µê¸ˆ'}</span><span class="pill">${f.payer}</span>${f.title||'ê³µê¸ˆ'}</div>
          <div class="sub">${Number(f.amount).toLocaleString()} ${f.currency} (â‰ˆ ${Math.round(krw).toLocaleString()} KRW)</div>
          ${f.memo ? `<div class="sub">ğŸ§¾ ${f.memo}</div>` : ''}
        </div><button class="danger">ì‚­ì œ</button>`;
        div.querySelector('button').onclick=()=>{ state.funds.splice(i,1); save(); };
        box.appendChild(div);
      });
    }

    function calc(){
      const n=Math.max(1,state.persons.length);
      const bal=Object.fromEntries(state.persons.map(p=>[p,0]));
      let totalExpense=0, totalFund=0;

      for(const e of state.expenses){
        const krw = toKrw(Number(e.amount||0), e.currency);
        totalExpense += krw;
        if ((e.category||'') === 'ê³µê¸ˆ' || (e.category||'') === 'ì˜ˆë¹„ë¹„') totalFund += krw;
        const share=krw/n;
        bal[e.payer]+=krw;
        state.persons.forEach(p=>bal[p]-=share);
      }

      // legacy funds support (kept for backward compatibility)
      for(const f of (state.funds||[])){
        const krw = toKrw(Number(f.amount||0), f.currency);
        totalExpense += krw;
        totalFund += krw;
        const share=krw/n;
        bal[f.payer]+=krw;
        state.persons.forEach(p=>bal[p]-=share);
      }

      return {bal,totalExpense,totalFund,net:totalExpense,perHead:(totalExpense)/n};
    }

    function renderSettlement(){
      const {bal,totalExpense,totalFund,net,perHead}=calc();
      $('totalKrw').textContent = `${Math.round(totalExpense).toLocaleString()} KRW`;
      $('totalFundKrw').textContent = `${Math.round(totalFund).toLocaleString()} KRW`;
      $('netKrw').textContent = `${Math.round(net).toLocaleString()} KRW`;
      $('perHeadKrw').textContent = `${Math.round(perHead).toLocaleString()} KRW`;

      $('kpiTotal').textContent = `${Math.round(totalExpense).toLocaleString()} KRW`;
      $('kpiNet').textContent = `${Math.round(net).toLocaleString()} KRW`;
      $('kpiPerHead').textContent = `${Math.round(perHead).toLocaleString()} KRW`;

      const sum=$('summary'); sum.innerHTML='';
      Object.entries(bal).forEach(([p,v])=>{
        const d=document.createElement('div'); d.className='item';
        d.innerHTML=`<span>${p}</span><strong>${Math.round(v).toLocaleString()} KRW</strong>`;
        sum.appendChild(d);
      });

      const debtors=[], creditors=[];
      for(const [p,v] of Object.entries(bal)){
        if(v<-1) debtors.push([p,-v]);
        if(v>1) creditors.push([p,v]);
      }
      debtors.sort((a,b)=>b[1]-a[1]);
      creditors.sort((a,b)=>b[1]-a[1]);

      const t=$('transfers'); t.innerHTML='';
      let i=0,j=0;
      const transferRows = [];
      while(i<debtors.length && j<creditors.length){
        const [dp,da]=debtors[i], [cp,ca]=creditors[j];
        const m=Math.min(da,ca);
        transferRows.push({ from: dp, to: cp, amount: Math.round(m) });
        debtors[i][1]-=m; creditors[j][1]-=m;
        if(debtors[i][1]<=1) i++;
        if(creditors[j][1]<=1) j++;
      }

      let doneCount = 0;
      transferRows.forEach((row, idx) => {
        const key = `${row.from}|${row.to}|${row.amount}|${idx}`;
        const checked = !!state.settled[key];
        if (checked) doneCount += 1;

        const d=document.createElement('div'); d.className='item';
        d.innerHTML=`
          <label class="transfer-row ${checked ? 'done' : ''}">
            <input type="checkbox" data-key="${key}" ${checked ? 'checked' : ''} />
            <span>${row.from} â†’ ${row.to}</span>
          </label>
          <strong class="${checked ? 'done' : ''}">${row.amount.toLocaleString()} KRW</strong>
        `;
        d.querySelector('input').addEventListener('change', (ev) => {
          state.settled[key] = ev.target.checked;
          save();
        });
        t.appendChild(d);
      });

      const ratio = transferRows.length ? Math.round((doneCount / transferRows.length) * 100) : 0;
      $('kpiDone').textContent = `${ratio}%`;
    }

    function render(){
      renderPersons();
      renderExpenses();
      renderFunds();
      renderSettlement();
    }

    async function fetchRateFromApi(){
      try{
        $('rateMeta').textContent = 'í™˜ìœ¨ API ì¡°íšŒ ì¤‘...';
        $('rateDisplay').value = 'ì¡°íšŒ ì¤‘...';
        const res = await fetch('https://open.er-api.com/v6/latest/JPY');
        const j = await res.json();
        const krw = Number(j?.rates?.KRW || 0);
        if(!krw) throw new Error('KRW rate missing');
        state.rate = krw;
        save();
        $('rateDisplay').value = `1 JPY = ${krw.toFixed(4)} KRW`; 
        const when = j?.time_last_update_utc || '';
        $('rateMeta').textContent = `API ë°˜ì˜ ì™„ë£Œ: 1 JPY = ${krw.toFixed(4)} KRW (${when})`;
      } catch {
        $('rateMeta').textContent = 'í™˜ìœ¨ API ì¡°íšŒ ì‹¤íŒ¨';
        $('rateDisplay').value = 'í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨';
      }
    }

    $('addPersonBtn').onclick=()=>{
      const v=$('personInput').value.trim();
      if(!v || state.persons.includes(v)) return;
      state.persons.push(v);
      $('personInput').value='';
      save();
    };

    $('addExpenseBtn').onclick=()=>{
      const title=$('title').value.trim()||'ì§€ì¶œ';
      const category=$('category').value||'ê¸°íƒ€';
      const amount=Number($('amount').value||0);
      const currency=$('currency').value;
      const payer=$('payer').value;
      const memo=$('memo').value.trim();
      if(amount<=0 || !payer) return;
      state.expenses.push({title,category,amount,currency,payer,memo,createdAt:Date.now()});
      state.settled = {}; // transfer map invalidated by data change
      $('title').value=''; $('amount').value=''; $('memo').value='';
      save();
    };

    $('addFundBtn').onclick=()=>{
      const title=$('fundTitle').value.trim()||'ê³µê¸ˆ';
      const category=$('fundCategory').value||'ê³µê¸ˆ';
      const amount=Number($('fundAmount').value||0);
      const currency=$('fundCurrency').value;
      const payer=$('fundPayer').value;
      const memo=$('fundMemo').value.trim();
      if(amount<=0 || !payer) return;
      state.funds.push({title,category,amount,currency,payer,memo,createdAt:Date.now()});
      state.settled = {}; // transfer map invalidated by data change
      $('fundTitle').value=''; $('fundAmount').value=''; $('fundMemo').value='';
      save();
    };

    $('fetchRateBtn').onclick=fetchRateFromApi;

    $('copyShareBtn').onclick = async () => {
      try {
        setStatus('ê³µìœ  ë§í¬ ìƒì„± ì¤‘...');
        const body = await createShareUrlOnServer();
        const url = body.url;
        const u = new URL(url);
        currentShareId = u.searchParams.get('sid');
        lastRemoteFingerprint = fp(state);
        history.replaceState(null, '', u.toString());
        startPolling();

        try {
          await navigator.clipboard.writeText(url);
          setStatus('ê³µìœ  ë§í¬ ë³µì‚¬ ì™„ë£Œ (ì‹¤ì‹œê°„ ë™ê¸°í™” ON)');
        } catch {
          prompt('ë³µì‚¬í•´ì„œ ê³µìœ í•˜ì„¸ìš”:', url);
        }
      } catch {
        setStatus('ê³µìœ  ë§í¬ ìƒì„± ì‹¤íŒ¨');
      }
    };

    $('loadShareBtn').onclick = async () => { await loadFromLink(); };

    $('resetBtn').onclick = () => {
      if(!confirm('ì „ì²´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      state.persons = ['ë§ˆë„¤'];
      state.expenses = [];
      state.funds = [];
      state.rate = 9.0;
      state.settled = {};
      save();
      setStatus('ì´ˆê¸°í™” ì™„ë£Œ');
    };

    // boot
    loadFromLink();
    render();
    fetchRateFromApi();
  </script>
</body>
</html>
